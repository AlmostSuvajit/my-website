<!DOCTYPE html>
<html lang="en">
<head>
	<title>Google Spreadsheet to JSON API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="title" content="Google Spreadsheet to JSON API"/>
	<meta name="description" content="Converts your Google Spreadsheet to JSON"/>
    <meta name="theme-color" content="#5970C1"/>
    <link rel="icon" href="icon.png" type="image/gif" sizes="16x16">
    <link type="application/json+oembed" href="https://almostsuvajit-xyz.firebaseapp.com/embed.json">
</head>
<body>
    <pre>
        <p id="data"></p>
    </pre>
    <script>
        let url_string =window.location.href;
        let url = new URL(url_string);
        let sheet = url.searchParams.get("sheet") || 1;
        let id = url.searchParams.get("id");
	    let query = url.searchParams.get("q") || '';
	    let useInt = url.searchParams.get("int") || true;
	    let showRows = url.searchParams.get("rows") || true;
        let showColumns = url.searchParams.get("columns") || true;
        
        let xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                let data = JSON.parse(this.responseText);
			    let Obj = {};
			    let rows = [];
			    let columns = {};

			    for (const entry of data.feed.entry.values()) {
				    let keys = Object.keys(entry);
				    let newRow = {};
				    let queried = false;

				    for (const key of keys.values()) {
					    let gsx = key.indexOf('gsx$');
					    if (gsx > -1) {
						    let name = key.substring(4);
						    let content = entry[key];
						    let value = content.$t;

						    if (value.toLowerCase().indexOf(query.toLowerCase()) > -1) {
							    queried = true;
						    }

						    if (useInt === true && !isNaN(value)) {
							    value = Number(value);
						    }

						    newRow[name] = value;
						    if (queried === true) {
							    if (!columns.hasOwnProperty(name)) {
								    columns[name] = [];
								    columns[name].push(value);
							    } else {
								    columns[name].push(value);
							    }
						    }
					    }
				    }

				    if (queried === true) {
					    rows.push(newRow);
				    }
			    }

			    if (showColumns === true) {
				    Obj.columns = columns;
			    }

			    if (showRows === true) {
				    Obj.rows = rows;
			    }

			    document.getElementById("data").innerHTML = JSON.stringify(Obj, null, ' ');
            }
        };
        xmlhttp.open("GET", `https://spreadsheets.google.com/feeds/list/${id}/${sheet}/public/values?alt=json`, true);
        xmlhttp.send();
    </script>
</body>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137877033-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-137877033-1')
    </script>
</html>